<plantilla>

<!-- Esta primer condición la tenemos comentada por defecto. Sirve para elegir la impresión por ticket o por A4 -->
<!-- Si se descomenta, imprimiría por A4 si no es FS o si es una devolución y el ticket origen no es FS e imprimiría por ticket si es FS o es una devolución y el ticket origen es FS-->
## #if( (!$ticket.getCabecera().getDatosDocOrigen() && ($ticket.getCabecera().getCodTipoDocumento() != "FS" && $ticket.getCabecera().getCodTipoDocumento() != "VC")) || ($ticket.getCabecera().getDatosDocOrigen() && ($ticket.getCabecera().getDatosDocOrigen().getCodTipoDoc() != "FS" && $ticket.getCabecera().getDatosDocOrigen().getCodTipoDoc() != "VC")) )
<!--	 <documento salida="impresora2" procesador="JASPER" fichero="facturas/facturaA4">		
	</documento>
	 <documento salida="impresora1">  -->

	##	#foreach ($pago in $ticket.getPagos())
	##		#set($esBoletaCompleta = true)
	##		#parse("./plantillas/detalle_pagos_boletas.xml")
	##	#end
	##	#parse("./plantillas/detalle_comprobantes_giftcard.xml")
	 <!-- </documento> -->

## #else
	#set($tienePagoGiftcard = false)
	#foreach ($pago in $ticket.getPagos())
		#if (${pago.isPagoTarjetaRegalo()})
			#set($tienePagoGiftcard = true)
			#break
		#end
	#end
	#if(!$paperLess || ( $paperLess && ($ticket.getCabecera().getDatosEnvio() || $tienePagoGiftcard)))
		<documento salida="impresora1">
		#if(!$paperLess)
			#if(!${salida.equals("pantalla")} && !${esCopia})
				<apertura-cajon></apertura-cajon>
			#end

			#if($imprimirLogo)
				<logo alignLogo="center"></logo>
			#end
			
			<linea line-size = "1"><texto size="39" align="center" >MARTIN MARTIN</texto></linea>
			<linea><texto> </texto></linea>

			#set( $imprimirDatosFacturacion =  $ticket.getCabecera().getCliente().getDatosFactura())
			#parse("./plantillas/datos_cabecera_openscale.xml")
			
			#set ($esServicioTerceros = $ticket.getCabecera().getCodTipoDocumento().equals("FSST"))

			<!--<linea><texto style ="1">ARTICULO              CANT   PVP  TOTAL</texto></linea>-->
			#set($imprimirnormalsize=true)
			#if($imprimirnormalsize)
				<linea><texto style ="1">ART CANT     PRECIO     DTO  IMPORTE</texto></linea>
			#else
				<linea><texto style ="1">ART CANT   PRECIO     DTO    IMPORTE</texto></linea>
			#end
			<linea><texto size = "36">------------------------------------</texto></linea>
			## LINEAS
			#set($totalArticulos=0)
			#set($moneda='€')
			
			#foreach ($linea in $ticket.getLineas())
				#set ($promoDescuento = false)
				#set ($textoPromo = "")
				#set ($importeDtoPromo = 0)  
			
				#if(!$linea.isPromocionesAplicadas())
				  #set ($enPromo = false)
				#else
				  #foreach ($promolinea in $linea.getPromociones())
					<!--Si se trata de una linea con promocion de descuento y tiene descuento(afecta a margen) pintar el total importe sin descuento y el descuento en otra linea-->
					#if(($promolinea.getIdTipoPromocion() != 6) && ($promolinea.getIdTipoPromocion() != 7) && ($promolinea.getTipoDescuento() == 0))
						 #set ($enPromo = true)
						 <!--Buscamos en las promociones del ticket para obtener los datos de la promocion-->
						 #foreach ($promo in $ticket.getPromociones())
							#if($promo.getIdPromocion() == $promolinea.getIdPromocion())
							   #set ($textoPromo = $promo.getTextoPromocion())
							   #set ($importeDtoPromo = $promolinea.getImporteTotalDtoMenosMargenAsStringNegate())  
							#end
						 #end
					#end
				   #end
				#end
				
				#set($unidad='un')	
				#set($cantidadLinea=$linea.getCantidad().intValue().toString())
				#if ($linea.getTipoArticulo().equals('P'))
					#set($unidad='kg')
					#set($totalArticulos=$totalArticulos + 1)
					#set($cantidadLinea=$linea.getCantidadAsString())
				#else
					#set($totalArticulos=$totalArticulos + $linea.getCantidad().intValue())
				#end

                <linea>
					<texto size="48" align="left" fontsize="4">${linea.getArticulo().getCodArticulo()}.-${linea.getArticulo().getDesArticulo()}</texto>
				</linea>  

                #if($imprimirnormalsize)		
					<linea> 
						<texto size="8" align="right">$cantidadLinea$unidad</texto>

						<texto size="11" align="right">$linea.getPrecioTotalSinDtoAsString()$moneda/$unidad</texto>
						
						<!--texto size="8" align="right">${linea.getDescuentoFinalConDecimalesAsString()}%</texto>--> 
						<texto size="17" align="right">${linea.getImporteTotalSinDtoAsString()}$moneda</texto> 
					</linea>	
				#else
					<linea> 
						<texto size="11" align="right" fontsize="4">$cantidadLinea$unidad</texto>

						<texto size="1" align="left" fontsize="4"> </texto>

						<texto size="11" align="right" fontsize="4">$linea.getPrecioTotalSinDtoAsString()$moneda/$unidad</texto>
						
						<!--<texto size="11" align="right" fontsize="4">${linea.getDescuentoFinalConDecimalesAsString()}%</texto>-->   
						<texto size="25" align="right" fontsize="4">${linea.getImporteTotalSinDtoAsString()}$moneda</texto> 
					</linea>	
				#end
				
				#if($esGestion && ${linea.getTransaccionOpenScale()})
					<linea>
						 <texto  fontsize="4">Openscale transaction:${linea.getTransaccionOpenScale()}</texto>
					</linea> 
				#end

			    <!--<linea> 
					 <texto size="24" align="left" fontsize="4">${linea.getArticulo().getDesArticulo()}</texto>
					 <texto size="10" align="right" fontsize="4">${linea.getCantidadAsString()}</texto>
					 <texto size="9" align="right" fontsize="4">${linea.getPrecioTotalSinDtoAsString()}</texto> 
					 <texto size="10" align="right" fontsize="4">${linea.getImporteTotalSinDtoAsString()}</texto> 
				</linea>--> 
				
				#if(false && $enPromo)
				   <linea><texto size="36" align="left" fontsize="4">    *$textoPromo => Importe dto:$importeDtoPromo</texto></linea>    
				#end
				
				#foreach ($numeroSerie in $linea.getNumerosSerie())
					<linea>
						<texto size="36" align="left">   *NS:${numeroSerie}</texto>
					</linea>
				#end 
			#end
			<linea>
			   <!--<texto fontsize="4">Total Artículos: ${ticket.getCabecera().getCantidadArticulosAsString()} </texto> -->
			   <texto fontsize="4" size="23" align="left">Total Artículos: $totalArticulos</texto>
			   <texto fontsize="4" size="25" align="right">***IMPUESTOS INCLUIDOS***</texto> 
			</linea>
			
			<linea><texto> </texto></linea>
			
			#PROMOCIONES
			#if(!$esServicioTerceros && ${ticket.tienePromocionesAhorroMayor0()})
				<linea> <texto fontsize="4">PROMOCIONES APLICADAS</texto> </linea>
				#foreach ($promocion in $ticket.getPromociones())
					#if(${promocion.getImporteTotalAhorro()} > 0 && !${promocion.isDescuentoAFuturo()})    	
						<linea>
							<texto size="33" align="left" fontsize="4">P${promocion.getIdPromocion()} ${promocion.getTextoPromocion()}</texto> 
							<texto size="1" align="left" fontsize="4"> </texto>
							<texto size="5" align="right" fontsize="4">${promocion.getImporteTotalAhorroAsString()}</texto> 
						</linea>
					#end
				#end
				<linea>
					<texto size="25" align="right" fontsize="4">TOTAL PROMOCIONES: </texto>
					<texto size="11" align="right" fontsize="4">${ticket.getTotales().getTotalPromocionesAsString()}</texto> 
				</linea>
				<linea><texto> </texto></linea>
			#end

			## TOTALES    
			<linea> 
				<texto size="25" align="right" >TOTAL A PAGAR: </texto>
				<texto size="11" align="right" >${ticket.getTotales().getTotalAPagarAsString()}$moneda</texto> 
			</linea>
			#if(${ticket.getTotales().isHayEntregaCuenta()})
			 <linea>
				<texto size="25" align="right">ENTREGADO A CUENTA: </texto>
				<texto size="11" align="right">${ticket.getTotales().getEntregadoACuentaAsString()}$moneda</texto> 
			</linea>
			#end
			<linea>
				<texto size="25" align="right">TOTAL ENTREGADO: </texto>
				<texto size="11" align="right">${ticket.getTotales().getEntregadoAsString()}$moneda</texto> 
			</linea>
			<linea> <texto size="36" align="right">----------</texto> </linea>
			<linea>
				<texto size="25" align="right">A DEVOLVER: </texto>
				<texto size="11" align="right">${ticket.getTotales().getCambioAsString()}$moneda</texto> 
			</linea>

			<linea><texto  fontsize="4">DETALLE DE PAGOS</texto></linea>
			<linea><texto size = "36">------------------------------------</texto></linea>
			#parse("./plantillas/detalle_pagos_openscale.xml")

			<!--<linea><texto fontsize="4">DESGLOSE IMPUESTOS</texto></linea>-->
			#if(!$esServicioTerceros)
				<linea><texto fontsize="4">     BASE               CUOTA     TOTAL</texto></linea>
				<linea><texto size = "36">------------------------------------</texto></linea>
				#foreach ($impuesto in $ticket.getCabecera().getSubtotalesIva())
					<linea>
						<texto size="9" align="right" fontsize="4">${impuesto.getBaseAsString()}</texto> 
						<texto size="20" align="right" fontsize="4"> ${impuesto.getCuotaAsString()}(${impuesto.getPorcentajeAsString()}%)</texto> 
						<texto size="10" align="right" fontsize="4">${impuesto.getTotalAsString()}</texto> 
					</linea>
				#end
			#end
			
			#FIDELIZADO y PUNTOS
			#if(!$esServicioTerceros && ${ticket.getCabecera().getDatosFidelizado()})
			    <linea><texto> </texto></linea>
				
				#set($tarjeta="")
				#if(${ticket.getCabecera().getDatosFidelizado().getNumTarjetaFidelizado()})
				   #set($tarjeta=${ticket.getCabecera().getDatosFidelizado().getNumTarjetaFidelizado()})
				#end
				
				#set($nombre="")
				#if (${ticket.getCabecera().getDatosFidelizado().getNombre()})
				   #set($nombre=$esc.xml(${ticket.getCabecera().getDatosFidelizado().getNombre()}))
				#end
				
				#set($apellido="")
				#if (${ticket.getCabecera().getDatosFidelizado().getApellido()})
					#set($apellido=$esc.xml(${ticket.getCabecera().getDatosFidelizado().getApellido()}))
				#end
				
				#if($apellido.equals($nombre))
				   <linea> <texto fontsize="4">TARJETA FIDELIZADO:$tarjeta Nombre:$nombre</texto></linea>
				#else
				   <linea> <texto fontsize="4">TARJETA FIDELIZADO:$tarjeta Nombre:$nombre $apellido</texto></linea>
				#end
				
				#if(false)
					#if (!${esCopia} && !${esGestion}) 
					<linea> <texto fontsize="4">Puntos acumulados:  ${ticket.getCabecera().getDatosFidelizado().getSaldoTotalAsString()}</texto> </linea>
					#end
					#if(${ticket.getTotales().getPuntos()} > 0)
						 <linea><texto fontsize="4">Ha obtenido ${ticket.getTotales().getPuntos()} puntos en esta compra.</texto></linea>
					#end
					#if(${ticket.getPuntosDevueltos()} > 0)
						 <linea><texto fontsize="4">Se han devuelto ${ticket.getPuntosDevueltos()} puntos en este ticket.</texto></linea>
					#end
				#end
			#end
		#end
		
		#if(${ticket.getCabecera().getDatosEnvio()})
		    <linea><texto> </texto></linea>
			<linea><texto align="center" size="36" fontsize="4">***ENVÍO A DOMICILIO***</texto></linea>
		#end
		#if(!$paperLess)
		    #if(!$esServicioTerceros)
			   <codbar align="center" tipo-leyenda="2" >${ticket.getCabecera().getLocalizador()}</codbar>
			#else
			   <linea><texto> </texto></linea>
            #end			   
			<!--<codbar type="QR">${urlQR}${ticket.getCabecera().getUidTicket()}</codbar>-->
			
			#set ($coma = $ticket.getCabecera().getCajero().getDesusuario().indexOf(',') + 1)  
			#if($coma>0)
			   #set($nombre = $ticket.getCabecera().getCajero().getDesusuario().substring($coma).trim())
			   <linea><texto fontsize="4">Le atendio $nombre</texto></linea>			   
			#else
	           <linea><texto fontsize="4">Le atendio $ticket.getCabecera().getCajero().getDesusuario()</texto></linea>
			#end
			
	        <linea><texto> </texto></linea>			
			<linea><texto>FECHA:${ticket.getCabecera().getFechaAsLocale()}</texto></linea>    
			<linea><texto>DOCUMENTO:${ticket.getCabecera().getCodTicket()}</texto></linea>			
			<linea><texto> </texto></linea>
			
				
			<linea> <texto size="36" align="center">CONSERVAR 15 DIAS EN CASO DE</texto> </linea>
			<linea> <texto size="36" align="center">RECLAMACION O DEVOLUCION</texto> </linea>
			<linea> <texto size="36" align="center">Excepto</texto> </linea>
			<linea> <texto size="36" align="center">Prensa-Revista-Entradas-Recargas</texto> </linea> 
			<linea> <texto size="36" align="center">***GRACIAS POR SU VISITA***</texto> </linea>
			<linea><texto> </texto></linea>
			<linea><texto> </texto></linea>
			<linea><texto> </texto></linea>
			<linea><texto> </texto></linea>
			#parse("./plantillas/promocion_texto_openscale.xml")
			#if(${apartado})
			   <corte></corte>
			   <linea><texto size="36" align="center">Justificante entrega articulos apartado</texto> </linea>
			   <linea></linea>  
			   <linea><texto>Apartado:${apartado}</texto> </linea>
			   #if ((${ticket.getCabecera().getCliente().getDatosFactura()}) && (${ticket.getCabecera().getCliente().getDatosFactura().getNombre()}))
				<linea><texto>Cliente:${ticket.getCabecera().getCliente().getDatosFactura().getNombre()}</texto> </linea>
			   #else
				  <linea><texto>Cliente:${ticket.getCliente().getNombreComercial()}</texto> </linea>
			   #end
			   <linea><texto>Fecha:${ticket.getCabecera().getFechaAsLocale()}</texto></linea>    
			   <linea><texto>${ticket.getCabecera().getDesTipoDocumento()}:${ticket.getCabecera().getCodTicket()}</texto> </linea>
			   <linea><texto>Importe:${ticket.getTotales().getTotalAPagarAsString()}</texto> </linea>
			   <linea> <texto> </texto> </linea>
			   <linea> <texto style ="1" >DETALLE DE PAGOS</texto> </linea>
		  	   <linea><texto size = "36">------------------------------------</texto></linea>
			   #parse("./plantillas/detalle_pagos_openscale.xml")
			   <linea> <texto> </texto> </linea>
			   <linea><texto size="36" align="center">Ejemplar para el establecimiento</texto> </linea>
			   <linea><texto> </texto></linea>
		       <linea><texto> </texto></linea>
			   <linea><texto> </texto></linea>	
                <linea><texto> </texto></linea>			   
			#end
		#end	
		<corte></corte>
		#foreach ($pago in $ticket.getPagos())
			#set($esBoletaCompleta = true)
			#parse("./plantillas/detalle_pagos_boletas_openscale.xml")
		#end	
		#parse("./plantillas/detalle_comprobantes_giftcard_openscale.xml")
		#if(${ticket.getCabecera().getDatosEnvio()})
			<linea><texto></texto></linea>
			<linea><texto></texto></linea>
			<linea><texto></texto></linea>
			<linea><texto align="center" size="36">DATOS DE ENVÍO</texto></linea>
			<linea><texto size = "36">------------------------------------</texto></linea>
			<linea>
				<textoalign="left" fontsize="4">${ticket.getCabecera().getDesTipoDocumento()}: ${ticket.getCabecera().getCodTicket()}</texto>
			</linea>
			#if (${ticket.getCabecera().getDatosEnvio().getNombreComercial()})
			  <linea><texto>Nombre: ${ticket.getCabecera().getDatosEnvio().getNombreComercial()}</texto></linea>
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getTipoIdentificacion()})
				#if(${ticket.getCabecera().getDatosEnvio().getCif()})
					<linea>
						<texto>${ticket.getCabecera().getDatosEnvio().getTipoIdentificacion()}: </texto>
						<texto align="left">${ticket.getCabecera().getDatosEnvio().getCif()}</texto>
					</linea>
				#end
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getDomicilio()})
			  <linea><texto>Domicilio: ${ticket.getCabecera().getDatosEnvio().getDomicilio()}</texto></linea>
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getPoblacion()})
			  <linea><texto>Poblacion: align="left">${ticket.getCabecera().getDatosEnvio().getPoblacion()}</texto></linea>
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getProvincia()})
			  <linea><texto>Provincia: ${ticket.getCabecera().getDatosEnvio().getProvincia()}</texto></linea>
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getLocalidad()})
			  <linea><texto>Localidad: ${ticket.getCabecera().getDatosEnvio().getLocalidad()}</texto></linea>
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getPais()})
			  <linea><texto>Pais: ${ticket.getCabecera().getDatosEnvio().getPais()}</texto></linea>
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getCp()})
			  <linea><texto>C.P.: ${ticket.getCabecera().getDatosEnvio().getCp()}</texto></linea>
			#end
			#if (${ticket.getCabecera().getDatosEnvio().getTelefono1()})
			  <linea><texto>Teléfono: ${ticket.getCabecera().getDatosEnvio().getTelefono1()}</texto></linea>
			#end
			<linea><texto></texto></linea>
			<linea><texto></texto></linea>
			<linea><texto></texto></linea>	  
			<linea><texto> </texto></linea>
			<corte></corte>
		#end
		
	   </documento>   
	#end
## #end 

  
</plantilla>